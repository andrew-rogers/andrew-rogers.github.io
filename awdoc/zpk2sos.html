<!DOCTYPE html>
<html>
	<head>
		<meta name="viewport" content="width=device-width, initial-scale=1.0" charset="UTF-8">
    <script src="AndrewWIDE.js"></script>
	</head>
	<body>
		<textarea id="aw_json" class="awjson" hidden>

AW{"type":"javascript", "hidden":"true"}
AndrewWIDE.loadWasmDSPModules(['signal']);

AW{"type":"mjmd"}

Design Notes for the WasmDSP Filter Functions: zpk2sos
======================================================

The first iteration of the zpk2sos function fails when a lowpass filter of odd order is transformed to a bandpass filter. This is because two real zeros are created and the zpk2sos handles them both as a conjugate pair.

AW{"type":"javascript"}
window.signal = AndrewWIDE.WasmDSP.modules.signal;

window.sosfreqz = function(sos) {
  let [h,w] = signal.sosfreqz(sos,2000);
  hmag = h.map((v) => 20 * Math.log10(Math.sqrt(v[0] * v[0] + v[1] * v[1])));
  plot(w, hmag);
  xlabel("&omega;");
  ylabel("|H(z)| (dB)");
}

window.print_zpk = function(z, p, k) {
  z.forEach((v) => print(`Zero @ ${v[0]} ${v[1]}i\n`));
  p.forEach((v) => print(`Pole @ ${v[0]} ${v[1]}i\n`));
  print(`Gain compensation: ${k}\n`);
}

AW{"type":"mjmd"}
Fifth order lowpass elliptic filter.

AW{"type":"javascript"}
let sos = signal.ellip(5,1,40,0.1);
sosfreqz(sos);

AW{"type":"mjmd"}
Tenth order bandpass elliptic filter using the zpk2sos from the WasmDSP signal library.

AW{"type":"javascript"}
let sos = signal.ellip(5,1,40,[0.1, 0.15],'bp');
sosfreqz(sos);

AW{"type":"mjmd"}
The zeros and poles for the tenth order banpass elliptic filter

AW{"type":"javascript"}
let [z, p, k] = signal.ellip(5,1,40,[0.1, 0.15],'bp',{sos: false});
print_zpk(z, p, k);
window.zpk = [z, p, k]

AW{"type":"mjmd"}
Tenth order bandpass elliptic filter using a new zpk2sos function as below

AW{"type":"javascript"}

function pairConjugates(arr) {
  arr.sort((a,b) => {
      return a[1] - b[1];
  });

  let odd = arr.length % 2;
  let N = (arr.length - odd) / 2;

  let ret = [];
  for (let n = 0; n < N; n++) {
    ret.push(arr[n]);
    ret.push(arr[arr.length-n-1]);
  }
  if (odd) ret.push(arr[N]);
  for (let n = 0; n < arr.length; n++) arr[n] = ret[n];
}

function pair2quadratic(a,b) {
  //   real( (s - a)(s - b) ) = ss - s * real(a+b) + real(ab)
  let p1 = -a[0] - b[0];
  let p2 = a[0] * b[0] - a[1] * b[1]; // Real part of complex multiply
  return [1, p1, p2];
}

function zpk2sos(z, p, k) {
  pairConjugates(z);
  pairConjugates(p);
  if (z.length % 2) z.push([0,0]);
  if (p.length % 2) p.push([0,0]);
  while (z.length < p.length) z.push([0,0]);
  while (p.length < z.length) p.push([0,0]);

  let sos = [];
  for (let n = 0; n < z.length; n+=2) {
    let zq = pair2quadratic(z[n], z[n+1]);
    let pq = pair2quadratic(p[n], p[n+1]);
    sos.push([...zq, ...pq]);
  }

  sos[0][0] *= k;
  sos[0][1] *= k;
  sos[0][2] *= k;
    
  return sos;
}

window.sos = zpk2sos(...zpk);
print_zpk(...zpk);

AW{"type":"javascript"}
sosfreqz(sos);



		</textarea>
		<script>
      new AwDocViewer( "serverless" );
		</script>
	</body>
</html>
