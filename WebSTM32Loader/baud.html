<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width">
        <title>STM32 USART Baud Acquisition</title>
        <script type="text/javascript" src="../AudioEffects/duplexaudio.js"></script>
        <script type="text/javascript" src="AudioUART.js"></script>
    </head>

    <body>
        <button id="button_gb">Get buffer</button>
        <div id="div_download"></div>
        <script>

/**
 *
 * @licstart  The following is the entire license notice for the 
 *  JavaScript code in this page.
 *
 * Copyright (C) 2019  Andrew Rogers
 *
 *
 * The JavaScript code in this page is free software: you can
 * redistribute it and/or modify it under the terms of the GNU
 * General Public License (GNU GPL) as published by the Free Software
 * Foundation, either version 3 of the License, or (at your option)
 * any later version.  The code is distributed WITHOUT ANY WARRANTY;
 * without even the implied warranty of MERCHANTABILITY or FITNESS
 * FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.
 *
 * As additional permission under GNU GPL version 3 section 7, you
 * may distribute non-source (e.g., minimized or compacted) forms of
 * that code without the copy of the GNU GPL normally required by
 * section 4, provided you include this license notice and a URL
 * through which recipients can access the Corresponding Source.
 *
 * @licend  The above is the entire license notice
 * for the JavaScript code in this page.
 *
 */

var button_gb = document.getElementById('button_gb');

var uart = new AudioUART();

var capture=[];

// --- DuplexAudio setup --------------

var init = function(media) {
    duplexAudio.start();
};


var samplesCallback = function(ip, op) {
    uart.processTx(op);
    //uart.processRx(ip);
    capture=capture.concat(ip)
    if (capture.length >40) duplexAudio.stop(); // Stop after four seconds of capture
};

var buffer_size = 4096;

var duplexAudio = new DuplexAudio(buffer_size, init, samplesCallback);

// ------------------------------------


// Stop button click handler
button_gb.onclick = function() {
    data=[]
    var k=0;
    str="";
    for (var b=0; b<capture.length; b++) {
        var buf=capture[b];
        for (n=0; n<buf.length; n++) {
            data[k++] = (buf[n]*32767) | 0; // Convert Float32 to 16-bit range integer
            str=str+((buf[n]*32767) | 0)+"\n";
        }
    }
    var blob=new Blob([str]);
    var url = URL.createObjectURL(blob);
    var fn = "sig_rx.vec"
    var a_download = '<a href="' + url + '" download="' + fn + '">Download "' + fn + '"</a>';
    document.getElementById("div_download").innerHTML=a_download;
}


        </script>
    </body>
</html>

