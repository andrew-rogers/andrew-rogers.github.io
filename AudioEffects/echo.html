<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width">
        <title>Echo using ScriptProcessorNode</title>  
    </head>

    <body>
        <button id="button_start">Start</button>
        <button id="button_stop">Stop</button>
        <script>

navigator.getUserMedia = (navigator.getUserMedia ||
                          navigator.webkitGetUserMedia ||
                          navigator.mozGetUserMedia ||
                          navigator.msGetUserMedia);

var button_start = document.getElementById('button_start');
var button_stop = document.getElementById('button_stop');
      
var audioCtx = new AudioContext();

var processSamples = function(input, output) {
    var N2 = input.length/2;
    for (var n = 0; n < N2; n++) {

        // Simple pitch doubler
        output[n] = input[n*2];
        output[N2+n] = input[n*2+1];     
    }
};

var initialiseAudioGraph = function(media) {
    var source = audioCtx.createMediaStreamSource(media);

    // Create the ScriptProcessorNode
    var buffer_size = 4096;
    var spn = audioCtx.createScriptProcessor(buffer_size, 1, 1);

    // Delay buffers
    var num_buffers=30;
    var input=[[]];
    for (var b=0; b<num_buffers; b++){
        input[b]=[];
        for (var n=0; n<buffer_size; n++) input[b][n]=0.0;
    }
    var cnt=0;

    spn.onaudioprocess = function(e) {
        var channel = 0;
        input[cnt] = e.inputBuffer.getChannelData(channel);
        var output = e.outputBuffer.getChannelData(channel);

        cnt=(cnt+1)%num_buffers;
        processSamples(input[cnt], output);
    }

    // Start button click handler
    button_start.onclick = function() {
        source.connect(spn);
        spn.connect(audioCtx.destination);
    }

    // Stop button click handler
    button_stop.onclick = function() {
        source.disconnect(spn);
        spn.disconnect(audioCtx.destination);
    }
      
      
};

   

var constraints = { video: false, audio: true };

navigator.getUserMedia(constraints, initialiseAudioGraph, function(err) {
    // errorCallback
    console.log("getUserMedia(): " + err);
});
      
      
        </script>
    </body>
</html>

